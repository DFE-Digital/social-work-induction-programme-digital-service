name: DB backup and restore

on:
  workflow_call:
    inputs:
      environment:
        description: "The GitHub environment to run the workflow against"
        type: string
        required: true
      action:
        description: "The action to perform (backup or restore)"
        required: true
        type: string
      db-name:
        description: "The actual database name to backup or restore (e.g., s205d01_db_moodle_primary)"
        required: true
        type: string
      container-suffix:
        description: "The suffix to use for container naming (e.g., moodle, usermanagement)"
        required: true
        type: string
      backup-file-name:
        description: "The name of the backup file in Blob Storage to restore from (required when action is 'restore')"
        required: false
        type: string
      instance:
        description: "The environment instance to operate on (e.g., d01, d02, d03)"
        required: true
        type: string
    secrets:
      AZ_CLIENT_ID:
        required: true
      AZ_TENANT_ID:
        required: true
      AZ_SUBSCRIPTION_ID:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  # Deploy ACI runner in the VNet
  deploy-runner:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      runner-name: ${{ steps.deploy.outputs.runner-name }}
    steps:
      - name: Login to Azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Get GitHub Runner Registration Token
        id: token
        run: |
          RUNNER_TOKEN=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token \
            | jq -r .token)
          echo "::set-output name=token::$RUNNER_TOKEN"

      - name: Deploy ACI Runner
        id: deploy
        run: |
          RUNNER_NAME="aci-runner-${{ github.run_id }}"
          RESOURCE_GROUP="s205${{ inputs.instance }}-swip-rg"

          # Deploy ACI with runner in the VNet
          az container create \
            --resource-group $RESOURCE_GROUP \
            --name $RUNNER_NAME \
            --image ghcr.io/actions/actions-runner:latest \
            --cpu 1 \
            --memory 2 \
            --vnet s205${{ inputs.instance }}-vnet \
            --subnet s205${{ inputs.instance }}-sn-funcapp \
            --environment-variables \
              RUNNER_NAME=$RUNNER_NAME \
              RUNNER_TOKEN=${{ steps.token.outputs.token }} \
              RUNNER_REPOSITORY_URL=https://github.com/${{ github.repository }} \
              RUNNER_LABELS=self-hosted,db-operations \
            --restart-policy Never \
            --assign-identity \
            --scope /subscriptions/${{ secrets.AZ_SUBSCRIPTION_ID }}/resourceGroups/$RESOURCE_GROUP

          echo "::set-output name=runner-name::$RUNNER_NAME"
          echo "runner-name=$RUNNER_NAME" >> $GITHUB_OUTPUT

      - name: Wait for runner to be ready
        run: |
          echo "Waiting for ACI runner to register and become ready..."
          sleep 60

  # Backup job using self-hosted runner
  backup:
    if: inputs.action == 'backup'
    needs: deploy-runner
    runs-on:
      labels: [self-hosted, db-operations]
    environment: ${{ inputs.environment }}
    steps:
      - name: Login to Azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Get Function Key from Key Vault
        run: |
          FUNCTION_KEY=$(az keyvault secret show \
            --name "DbOperationsService-FunctionKey" \
            --vault-name "s205${{ inputs.instance }}-kv-primary" \
            --query value -o tsv)

          # Mask the secret to prevent it from appearing in logs
          echo "::add-mask::$FUNCTION_KEY"

          echo "FUNCTION_KEY=$FUNCTION_KEY" >> $GITHUB_ENV

      - name: Validate inputs
        run: |
          # Validate action parameter
          if [ "${{ inputs.action }}" != "backup" ] && [ "${{ inputs.action }}" != "restore" ]; then
            echo "Error: Invalid action '${{ inputs.action }}'. Must be 'backup' or 'restore'."
            exit 1
          fi

          # Validate that backup operations don't have a backup file name (should be empty)
          if [ "${{ inputs.action }}" = "backup" ] && [ -n "${{ inputs.backup-file-name }}" ]; then
            echo "Error: backup-file-name should not be provided when action is 'backup'"
            exit 1
          fi

      - name: Backup ${{ inputs.db-name }} database on ${{ inputs.instance }}
        run: |
          # Use internal function app endpoint (accessible from VNet)
          FUNCTION_APP_NAME="s205${{ inputs.instance }}-fa-db-jobs"
          INTERNAL_ENDPOINT="https://$FUNCTION_APP_NAME.azurewebsites.net/api/DbOperationsFunction"
          STORAGE_ACCOUNT="s205${{ inputs.instance }}sabackups"
          CONTAINER="s205${{ inputs.instance }}-${{ inputs.container-suffix }}-backups"

          JSON_PAYLOAD=$(cat <<EOF
          {
            "action": "backup",
            "databaseName": "${{ inputs.db-name }}",
            "storageAccount": "$STORAGE_ACCOUNT",
            "containerName": "$CONTAINER"
          }
          EOF
          )

          echo "DB Operation: backup ${{ inputs.db-name }} on ${{ inputs.instance }}"
          echo "Using Function App: $FUNCTION_APP_NAME"
          echo "Internal Endpoint: $INTERNAL_ENDPOINT"
          echo "Container: $CONTAINER"

          RESPONSE=$(curl -X POST "$INTERNAL_ENDPOINT?code=$FUNCTION_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -w "\nHTTP_STATUS:%{http_code}")

          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "Response status: $HTTP_STATUS"
          echo "Response body: $RESPONSE_BODY"

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "DB operation failed: backup ${{ inputs.db-name }} on ${{ inputs.instance }}"
            exit 1
          fi

  # Restore job using self-hosted runner
  restore:
    if: inputs.action == 'restore'
    needs: deploy-runner
    runs-on:
      labels: [self-hosted, db-operations]
    environment: ${{ inputs.environment }}
    steps:
      - name: Validate backup file name
        run: |
          if [ -z "${{ inputs.backup-file-name }}" ]; then
            echo "Error: backup-file-name is required when action is 'restore'"
            exit 1
          fi

      - name: Login to Azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Get Function Key from Key Vault
        run: |
          FUNCTION_KEY=$(az keyvault secret show \
            --name "DbOperationsService-FunctionKey" \
            --vault-name "s205${{ inputs.instance }}-kv-primary" \
            --query value -o tsv)

          # Mask the secret to prevent it from appearing in logs
          echo "::add-mask::$FUNCTION_KEY"

          echo "FUNCTION_KEY=$FUNCTION_KEY" >> $GITHUB_ENV

      - name: Validate inputs
        run: |
          # Validate action parameter
          if [ "${{ inputs.action }}" != "backup" ] && [ "${{ inputs.action }}" != "restore" ]; then
            echo "Error: Invalid action '${{ inputs.action }}'. Must be 'backup' or 'restore'."
            exit 1
          fi

          # Validate that restore operations have a backup file name
          if [ "${{ inputs.action }}" = "restore" ] && [ -z "${{ inputs.backup-file-name }}" ]; then
            echo "Error: backup-file-name is required when action is 'restore'"
            exit 1
          fi

      - name: Restore ${{ inputs.db-name }} database on ${{ inputs.instance }}
        run: |
          # Use internal function app endpoint (accessible from VNet)
          FUNCTION_APP_NAME="s205${{ inputs.instance }}-fa-db-jobs"
          INTERNAL_ENDPOINT="https://$FUNCTION_APP_NAME.azurewebsites.net/api/DbOperationsFunction"
          STORAGE_ACCOUNT="s205${{ inputs.instance }}sabackups"
          CONTAINER="s205${{ inputs.instance }}-${{ inputs.container-suffix }}-backups"

          JSON_PAYLOAD=$(cat <<EOF
          {
            "action": "restore",
            "databaseName": "${{ inputs.db-name }}",
            "storageAccount": "$STORAGE_ACCOUNT",
            "containerName": "$CONTAINER",
            "backupFileName": "${{ inputs.backup-file-name }}"
          }
          EOF
          )

          echo "DB Operation: restore ${{ inputs.db-name }} on ${{ inputs.instance }}"
          echo "Using Function App: $FUNCTION_APP_NAME"
          echo "Internal Endpoint: $INTERNAL_ENDPOINT"
          echo "Container: $CONTAINER"

          RESPONSE=$(curl -X POST "$INTERNAL_ENDPOINT?code=$FUNCTION_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -w "\nHTTP_STATUS:%{http_code}")

          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "Response status: $HTTP_STATUS"
          echo "Response body: $RESPONSE_BODY"

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "DB operation failed: restore ${{ inputs.db-name }} on ${{ inputs.instance }}"
            exit 1
          fi

  # Cleanup: Remove ACI runner
  cleanup:
    needs: [deploy-runner, backup, restore]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    if: always()
    steps:
      - name: Login to Azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Remove ACI Runner
        run: |
          RESOURCE_GROUP="s205${{ inputs.instance }}-swip-rg"
          RUNNER_NAME="${{ needs.deploy-runner.outputs.runner-name }}"

          echo "Removing ACI runner: $RUNNER_NAME"
          az container delete \
            --resource-group $RESOURCE_GROUP \
            --name $RUNNER_NAME \
            --yes || echo "Runner cleanup completed"
