name: Generate Magic Link Token

run-name: "Generate Magic Link Token - ${{ inputs.environment }} (${{ inputs.reason }})"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rotate token for"
        required: true
        default: "d01"
        type: choice
        options:
          - d01
          - d02
          - d03
      reason:
        description: "Reason for token rotation"
        required: false
        type: string
        default: "Manual rotation"
  # schedule:
  #   - cron: '0 9 * * 1'

permissions:
  id-token: write
  contents: read

jobs:
  generate-token:
    name: "Generate and Store Magic Link Token"
    runs-on: ubuntu-latest
    environment: Dev

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Login to Azure CLI
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Load Terraform Variables
        uses: ./.github/actions/pre-process-terraform-variables
        with:
          environment: ${{ inputs.environment }}
          add-as-env-vars: true

      - name: Setup Infrastructure Details
        run: |
          set -euo pipefail
          export TF_VAR_FILE=/tmp/merged.tfvars
          export RESOURCE_NAME_PREFIX=$(awk -F'"' '/resource_name_prefix/ {print $2}' $TF_VAR_FILE)

          KV_NAME="${RESOURCE_NAME_PREFIX}-kv-primary"
          echo "âœ… Constructed Key Vault name: ${KV_NAME}"
          echo "kv_name=${KV_NAME}" >> $GITHUB_ENV

          MAGIC_LINKS_ENABLED=$(awk -F'"' '/magic_links_enabled/ {print $2}' $TF_VAR_FILE 2>/dev/null || echo "false")
          if [ "$MAGIC_LINKS_ENABLED" != "true" ]; then
            echo "âš ï¸  Magic links are disabled in ${{ inputs.environment }}/env.tfvars"
            echo "   The workflow will continue but magic links won't work in this environment"
            echo "   To enable: set magic_links_enabled = true in your env.tfvars file"
          else
            echo "âœ… Magic links are enabled for this environment"
          fi

      - name: Generate New Token
        id: generate-token
        run: |
          set -euo pipefail
          NEW_TOKEN=$(openssl rand -hex 16)

          # Mask the token in log
          echo "::add-mask::${NEW_TOKEN}"

          echo "ðŸ” New magic link token generated successfully"
          echo "token=${NEW_TOKEN}" >> $GITHUB_OUTPUT

      - name: Update Key Vault Secret
        id: update-secret
        run: |
          set -euo pipefail
          echo "ðŸ”‘ Updating Key Vault secret..."
          echo "   Key Vault: ${kv_name}"
          echo "   Secret: MagicLink-Token"

          SECRET_INFO=$(az keyvault secret set \
            --vault-name "${kv_name}" \
            --name "MagicLink-Token" \
            --value "${{ steps.generate-token.outputs.token }}" \
            --content-type "alphanumeric token string" \
            --only-show-errors \
            -o json)

          if [ -z "$SECRET_INFO" ]; then
            echo "âŒ Failed to update Key Vault secret"
            exit 1
          fi

          SECRET_VERSION=$(echo "$SECRET_INFO" | jq -r .id | awk -F'/' '{print $NF}')
          echo "secret_version=${SECRET_VERSION}" >> $GITHUB_OUTPUT

          echo "âœ… Token successfully updated in Key Vault"

      - name: Token Rotation Complete
        run: |
          set -euo pipefail
          cat <<EOF | tee -a $GITHUB_STEP_SUMMARY
          ## âœ… Magic Link Token Rotation Complete

          ### ðŸ“Š Summary
          - Environment: ${{ inputs.environment }}
          - Token Updated: âœ…
          - Key Vault: ${kv_name}
          - Secret Version: ${{ steps.update-secret.outputs.secret_version }}

          ### ðŸ“‹ Next Steps
          1. Retrieve the new token from Key Vault:
             - Key Vault: ${kv_name}
             - Secret Name: MagicLink-Token
          2. Update the Confluence environment access page:
             - [Confluence Page](https://dfedigital.atlassian.net/wiki/x/CIBSQwE)
          3. Find the **${{ inputs.environment }}** section and replace the old token in the links

          ### ðŸ” Security
          - Token is stored securely in Key Vault only
          - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF

