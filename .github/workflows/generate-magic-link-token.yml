name: Generate Magic Link Token

run-name: "Generate Magic Link Token - ${{ inputs.environment }} (${{ inputs.reason }})"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rotate token for"
        required: true
        default: "d01"
        type: choice
        options:
          - d01
          - d02
          - d03
      reason:
        description: "Reason for token rotation"
        required: false
        type: string
        default: "Manual rotation"
  # schedule:
  #   - cron: '0 9 * * 1'

permissions:
  id-token: write
  contents: read

jobs:
  generate-token:
    name: "Generate and Store Magic Link Token"
    runs-on: ubuntu-latest
    environment: Dev

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Login to Azure CLI
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Load Terraform Variables
        uses: ./.github/actions/pre-process-terraform-variables
        with:
          environment: ${{ inputs.environment }}
          add-as-env-vars: true

      - name: Setup Infrastructure Details
        run: |
          set -euo pipefail
          export TF_VAR_FILE=/tmp/merged.tfvars
          export RESOURCE_NAME_PREFIX=$(awk -F'"' '/resource_name_prefix/ {print $2}' $TF_VAR_FILE)

          KV_NAME="${RESOURCE_NAME_PREFIX}-kv-primary"
          echo "âœ… Constructed Key Vault name: ${KV_NAME}"
          echo "kv_name=${KV_NAME}" >> $GITHUB_ENV

          MAGIC_LINKS_ENABLED=$(awk -F'"' '/magic_links_enabled/ {print $2}' $TF_VAR_FILE 2>/dev/null || echo "false")
          if [ "$MAGIC_LINKS_ENABLED" != "true" ]; then
            echo "âš ï¸  Magic links are disabled in ${{ inputs.environment }}/env.tfvars"
            echo "   The workflow will continue but magic links won't work in this environment"
            echo "   To enable: set magic_links_enabled = true in your env.tfvars file"
          else
            echo "âœ… Magic links are enabled for this environment"
          fi

      - name: Generate New Token
        id: generate-token
        run: |
          set -euo pipefail
          NEW_TOKEN=$(openssl rand -hex 16)

          # Mask the token in log
          echo "::add-mask::${NEW_TOKEN}"

          echo "ðŸ” New magic link token generated successfully"
          echo "token=${NEW_TOKEN}" >> $GITHUB_OUTPUT

      - name: Update Key Vault Secret
        id: update-secret
        run: |
          set -euo pipefail
          echo "ðŸ”‘ Updating Key Vault secret..."
          echo "   Key Vault: ${kv_name}"
          echo "   Secret: MagicLink-Token"

          SECRET_INFO=$(az keyvault secret set \
            --vault-name "${kv_name}" \
            --name "MagicLink-Token" \
            --value "${{ steps.generate-token.outputs.token }}" \
            --content-type "alphanumeric token string" \
            --only-show-errors \
            -o json)

          if [ -z "$SECRET_INFO" ]; then
            echo "âŒ Failed to update Key Vault secret"
            exit 1
          fi

          SECRET_VERSION=$(echo "$SECRET_INFO" | jq -r .id | awk -F'/' '{print $NF}')
          echo "secret_version=${SECRET_VERSION}" >> $GITHUB_OUTPUT

          echo "âœ… Token successfully updated in Key Vault"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: 1.11.3
          terraform_wrapper: false

      - name: Generate Terraform State Variables
        run: |
          set -euo pipefail
          export TF_VAR_FILE=/tmp/merged.tfvars
          export RESOURCE_NAME_PREFIX=$(awk -F'"' '/resource_name_prefix/ {print $2}' $TF_VAR_FILE)
          echo "TF_STATE_AZURE_REGION=$(awk -F'\"' '/azure_region/ {print $2}' $TF_VAR_FILE)" >> $GITHUB_ENV
          echo "TF_STATE_RESOURCE_GROUP=$RESOURCE_NAME_PREFIX-swip-rg-tfstate" >> $GITHUB_ENV
          echo "TF_STATE_STORAGE_ACCOUNT_NAME=${RESOURCE_NAME_PREFIX}swipsatfstate" >> $GITHUB_ENV
          echo "TF_STATE_CONTAINER_NAME=${RESOURCE_NAME_PREFIX}swipconttfstate" >> $GITHUB_ENV
          echo "TF_STATE_KEY=$RESOURCE_NAME_PREFIX-swip-tfstate" >> $GITHUB_ENV
          echo "TF_VAR_FILE=$TF_VAR_FILE" >> $GITHUB_ENV

      - name: Terraform Init
        run: |
          set -euo pipefail
          cd terraform
          terraform init \
            -backend-config="resource_group_name=$TF_STATE_RESOURCE_GROUP" \
            -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT_NAME" \
            -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
            -backend-config="key=$TF_STATE_KEY"

      - name: Plan Front Door Updates
        run: |
          set -euo pipefail
          cd terraform
          echo "ðŸ“‹ Planning Front Door rule updates..."

          terraform plan \
            -target=module.stack.azurerm_key_vault_secret.magic_link_token \
            -target=module.stack.azurerm_cdn_frontdoor_rule.token_validation \
            -target=module.stack.azurerm_cdn_frontdoor_rule.cookie_validation \
            -target=module.stack.azurerm_cdn_frontdoor_firewall_policy.magic_link_waf \
            -target=module.stack.azurerm_cdn_frontdoor_security_policy.magic_link_security \
            -var-file=$TF_VAR_FILE \
            -var='moodle_admin_password=${{ secrets.MOODLE_ADMIN_PASSWORD }}' \
            -var='moodle_admin_email=${{ vars.MOODLE_ADMIN_EMAIL }}' \
            -var='moodle_admin_user=${{ vars.MOODLE_ADMIN_USER }}' \
            -var='auth_service_client_id=${{ vars.AUTH_SERVICE_CLIENT_ID }}' \
            -var='moodle_web_service_name=${{ vars.MOODLE_WEB_SERVICE_NAME }}' \
            -var='moodle_web_service_user=${{ vars.MOODLE_WEB_SERVICE_USER }}' \
            -var='moodle_web_service_user_email=${{ vars.MOODLE_WEB_SERVICE_USER_EMAIL }}' \
            -var='email_support_address=${{ vars.EMAIL_SUPPORT_ADDRESS }}' \
            -var='govnotify_api_key=${{secrets.GOVNOTIFY_API_KEY}}' \
            -no-color \
            -out=tfplan-magic-link

          echo "âœ… Plan generated successfully"

      - name: Update Front Door Rules
        run: |
          set -euo pipefail
          cd terraform
          echo "ðŸ”„ Applying Front Door rule updates..."

          terraform apply -auto-approve tfplan-magic-link

          echo "âœ… Front Door rules updated successfully"

      - name: Token Rotation Complete
        run: |
          set -euo pipefail
          cat <<EOF | tee -a $GITHUB_STEP_SUMMARY
          ## âœ… Magic Link Token Rotation Complete

          ### ðŸ“Š Summary
          - Environment: ${{ inputs.environment }}
          - Token Generated: âœ…
          - Key Vault Updated: âœ…
          - Front Door Rules Updated: âœ…
          - Secret Version: ${{ steps.update-secret.outputs.secret_version }}

          ### ðŸ“‹ Next Steps
          1. Retrieve the new token from Key Vault:
             - Key Vault: ${kv_name}
             - Secret Name: MagicLink-Token
          2. Update the Confluence environment access page:
             - [Confluence Page](https://dfedigital.atlassian.net/wiki/x/CIBSQwE)
          3. Find the **${{ inputs.environment }}** section and replace the old token in the links

          ### ðŸ” Security
          - Token is stored securely in Key Vault only
          - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF
