{"version":3,"file":"manualsavegroup.min.js","sources":["../src/manualsavegroup.js"],"sourcesContent":["/* eslint-disable no-console */     // allow console.log for now for grunt amd eslinting\nimport $ from 'jquery';\nimport { addNotification } from 'core/notification';\n\n/**\n * @module local_manualsavegroup/manualsavegroup\n */\n\n/**\n * Initialise manual save group behaviour on the members.php page.\n *\n * Hide the default add/remove buttons, inject ‚ÄúSave changes‚Äù and move controls,\n * and handle batching of add/remove via AJAX.\n *\n * @returns {void}\n */\nexport const init = () => {\n    console.log('manualsavegroup.init running');\n\n    // hide the built-in arrows\n    $('#add, #remove').hide();\n\n    // inject ‚ÄúSave changes‚Äù button\n    const form = $('#assignform');\n    if (!form.length) {\n        return;\n    }\n\n    if (!$('#batch-save-btn').length) {\n        form.append(\n            '<button id=\"batch-save-btn\" type=\"submit\" ' +\n            'class=\"btn btn-primary mb-2\">Save changes</button>'\n        );\n    }\n\n    // inject Move buttons between the selects\n    if (!$('#btn-move-add').length) {\n        const moveControls = $(\n            '<div id=\"move-controls\" style=\"margin: .5em 0; text-align:center;\">' +\n            '<button type=\"button\" id=\"btn-move-add\"    class=\"btn btn-secondary btn-sm\">Add Selected  ‚Üê</button>&nbsp;' +\n            '<button type=\"button\" id=\"btn-move-remove\" class=\"btn btn-secondary btn-sm\">‚Üí  Remove Selected</button>' +\n            '</div>'\n        );\n        $('#buttonscell').html(moveControls);\n    }\n\n    // add member handler\n    $('#btn-move-add').on('click', () => {\n        $('#addselect option:selected')\n            .prop('selected', false)\n            .appendTo('#removeselect');\n    });\n\n    // remove member handler\n    $('#btn-move-remove').on('click', () => {\n        $('#removeselect option:selected')\n            .prop('selected', false)\n            .appendTo('#addselect');\n    });\n\n    // take a snapshot of the original group members\n    const original = $('#removeselect option')\n        .map((i, o) => o.value)\n        .get();\n\n    form.off('submit.manualsave').on('submit.manualsave', async function (e) {\n        // If the user clicks the \"back to groups\" button, action it\n        const trigger = e.originalEvent && e.originalEvent.submitter;\n        if (trigger && trigger.name === 'cancel') {\n            return;\n        }\n        e.preventDefault();\n\n        // read current list\n        const current = $('#removeselect option')\n            .map((i, o) => o.value)\n            .get();\n\n        // compute who was added/removed\n        const toAdd = current.filter(id => !original.includes(id));\n        const toRemove = original.filter(id => !current.includes(id));\n\n        console.log('üõ†Ô∏è toAdd=', toAdd, 'toRemove=', toRemove);\n\n        const sesskey = form.find('input[name=\"sesskey\"]').val();\n        const actionUrl = form.attr('action');\n\n        /**\n         * Submit a batch of add/remove requests to the group members page.\n         *\n         * @param {'add'|'remove'} buttonName - Name of the submit button (\"add\" or \"remove\").\n         * @param {string} fieldName - Name of the select field (\"addselect\" or \"removeselect\").\n         * @param {string[]} ids - Array of user ID strings.\n         * @returns {Promise<void>}\n         */\n        async function postChange(buttonName, fieldName, ids) {\n            if (!ids.length) {\n                return;\n            }\n            const data = new URLSearchParams();\n            data.append('sesskey', sesskey);\n            data.append(buttonName, '1');\n            ids.forEach(id => data.append(`${fieldName}[]`, id));\n            await fetch(actionUrl, {\n                method: 'POST',\n                credentials: 'same-origin',\n                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n                body: data.toString()\n            });\n        }\n\n        // add members\n        await postChange('add', 'addselect', toAdd);\n        // remove members\n        await postChange('remove', 'removeselect', toRemove);\n\n        // notification below not working - would need to explore further\n        // notify & reload\n        addNotification({\n            message: M.util.get_string('changessaved', 'local_manualsavegroup'),\n            type: 'success',\n            closebutton: true,\n            announce: true\n        });\n        window.location.reload();\n\n    });\n};\n"],"names":["console","log","hide","form","length","append","moveControls","html","on","prop","appendTo","original","map","i","o","value","get","off","async","e","trigger","originalEvent","submitter","name","preventDefault","current","toAdd","filter","id","includes","toRemove","sesskey","find","val","actionUrl","attr","postChange","buttonName","fieldName","ids","data","URLSearchParams","forEach","fetch","method","credentials","headers","body","toString","message","M","util","get_string","type","closebutton","announce","window","location","reload"],"mappings":"6RAgBoB,KAChBA,QAAQC,IAAI,oDAGV,iBAAiBC,aAGbC,MAAO,mBAAE,mBACVA,KAAKC,kBAIL,mBAAE,mBAAmBA,QACtBD,KAAKE,OACD,kGAMH,mBAAE,iBAAiBD,OAAQ,OACtBE,cAAe,mBACjB,kTAKF,gBAAgBC,KAAKD,kCAIzB,iBAAiBE,GAAG,SAAS,yBACzB,8BACGC,KAAK,YAAY,GACjBC,SAAS,wCAIhB,oBAAoBF,GAAG,SAAS,yBAC5B,iCACGC,KAAK,YAAY,GACjBC,SAAS,uBAIZC,UAAW,mBAAE,wBACdC,KAAI,CAACC,EAAGC,IAAMA,EAAEC,QAChBC,MAELb,KAAKc,IAAI,qBAAqBT,GAAG,qBAAqBU,eAAgBC,SAE5DC,QAAUD,EAAEE,eAAiBF,EAAEE,cAAcC,aAC/CF,SAA4B,WAAjBA,QAAQG,YAGvBJ,EAAEK,uBAGIC,SAAU,mBAAE,wBACbb,KAAI,CAACC,EAAGC,IAAMA,EAAEC,QAChBC,MAGCU,MAAQD,QAAQE,QAAOC,KAAOjB,SAASkB,SAASD,MAChDE,SAAWnB,SAASgB,QAAOC,KAAOH,QAAQI,SAASD,MAEzD5B,QAAQC,IAAI,aAAcyB,MAAO,YAAaI,gBAExCC,QAAU5B,KAAK6B,KAAK,yBAAyBC,MAC7CC,UAAY/B,KAAKgC,KAAK,yBAUbC,WAAWC,WAAYC,UAAWC,SACxCA,IAAInC,oBAGHoC,KAAO,IAAIC,gBACjBD,KAAKnC,OAAO,UAAW0B,SACvBS,KAAKnC,OAAOgC,WAAY,KACxBE,IAAIG,SAAQd,IAAMY,KAAKnC,iBAAUiC,gBAAeV,YAC1Ce,MAAMT,UAAW,CACnBU,OAAQ,OACRC,YAAa,cACbC,QAAS,gBAAkB,qCAC3BC,KAAMP,KAAKQ,mBAKbZ,WAAW,MAAO,YAAaV,aAE/BU,WAAW,SAAU,eAAgBN,4CAI3B,CACZmB,QAASC,EAAEC,KAAKC,WAAW,eAAgB,yBAC3CC,KAAM,UACNC,aAAa,EACbC,UAAU,IAEdC,OAAOC,SAASC"}