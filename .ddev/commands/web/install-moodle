#!/bin/bash
# .ddev/commands/web/install-moodle
# This script performs a full Moodle installation:
# 1. Runs the CLI installer.
# 2. Downloads and installs the govuk theme.
# 3. Updates config.php to set the govuk theme.
# 4. Purges Moodle caches.

set -e

echo "Starting Moodle CLI installation..."
php public/admin/cli/install.php \
  --non-interactive \
  --agree-license \
  --wwwroot="$DDEV_PRIMARY_URL" \
  --dbtype=pgsql \
  --dbhost=db \
  --dbname=db \
  --dbuser=db \
  --dbpass=db \
  --fullname="Social Work Induction Programme" \
  --shortname=SWIP \
  --adminpass=password \
  --adminemail=admin@example.com

echo "Moodle installation complete."

echo "Downloading and installing govuk theme..."
rm -rf /tmp/theme
curl -L -o /tmp/govuk-moodle-theme.zip "https://github.com/DFE-Digital/govuk-moodle-theme/releases/download/2024200800/govuk-moodle-theme.zip"
unzip -o /tmp/govuk-moodle-theme.zip -d /tmp/theme
mkdir -p /var/www/html/public/theme
mv /tmp/theme/govuk/ /var/www/html/public/theme/govuk
rm -rf /tmp/govuk-moodle-theme.zip /tmp/theme
echo "Govuk theme installed."

echo "Updating config.php to set theme to govuk..."
CONFIG_FILE="/var/www/html/public/config.php"
if grep -q "\$CFG->theme" "$CONFIG_FILE"; then
  sed -i "s/\(\$CFG->theme\s*=\s*\).*/\1'govuk';/" "$CONFIG_FILE"
else
  echo "\$CFG->theme = 'govuk';" >> "$CONFIG_FILE"
fi

echo "Purging Moodle caches..."
php public/admin/cli/purge_caches.php

echo "All steps complete. Your Moodle installation is now using the govuk theme."
